````md
# GIDSAM UI SYSTEM — TRACKING (Analytics + Fairness + Turbo) v1.1

Этот файл — канонический стандарт трекинга для проекта «ГИДСАМ».
Любые блоки, страницы, виджеты и локальные страницы ОБЯЗАНЫ считать показы/клики строго по этим правилам.
Никаких “у меня по-другому”, никаких “так проще”. Любое отклонение ломает аналитику, fairness и монетизацию.

---

## 0) Термины и сущности

**Entity** — любая карточка/объект: company / event / promo / job / article / assortment / clip / banner.
**Block** — UI-блок на странице (например: “Акции”, “Афиши”, “Компании”).
**Impression (показ)** — факт видимого попадания карточки/баннера на экран по правилам ниже.
**Click (клик)** — клик по карточке целиком или по action-кнопкам (call/route/share/open/etc).
**Pos (позиция)** — порядковый номер элемента в выдаче внутри блока на момент рендера (1..N).
**Request_id** — id конкретной выдачи/запроса (одна загрузка данных = один request_id).
**Session** — текущая сессия пользователя (условно: пока вкладка/браузер живы + TTL).

---

## 1) Обязательная схема событий (единый формат)

Любой трекинг отправляется в одном формате:

```json
{
  "ts": 0,
  "session_id": "",
  "user_id": null,
  "anon_id": "",
  "page_id": "",
  "page_type": "",
  "city_id": "",
  "block_id": "",
  "block_type": "",
  "request_id": "",
  "event": "impression|click",
  "entity_type": "company|event|promo|job|article|assortment|clip|banner",
  "entity_id": "",
  "pos": 0,
  "slot": "",
  "is_ad": false,
  "erid": null,
  "ad_status": "",
  "is_sponsored": false,
  "sponsor_slot": null,
  "is_turbo": false,
  "turbo_mult": 1,
  "seed": "",
  "algo": "",
  "filters": {},
  "referrer": "",
  "url": "",
  "ua": "",
  "action": null,
  "meta": {}
}
````

**Пояснения ключевых полей:**

* `ts` — Unix ms.
* `session_id` — стабильный id сессии (генерируем на клиенте, сохраняем).
* `anon_id` — стабильный id устройства/браузера (localStorage).
* `page_id` — id страницы (например: `home`, `catalog_companies`, `promo_page`).
* `page_type` — `home|catalog|local|details|search`.
* `city_id` — обязателен.
* `block_id` — уникальный id блока на странице (например: `home_promos`, `cat_events_grid`).
* `block_type` — тип блока (`promos|events|companies|jobs|banners|clips|articles|assort`).
* `request_id` — уникальный id выдачи/ответа API/витрины.
* `entity_type/entity_id` — тип и id сущности.
* `pos` — позиция внутри блока в текущей выдаче (1..N).
* `slot` — строковый слот (если есть: `hero_1`, `reco_3`, `sponsor_2`).
* `is_ad/erid/ad_status` — логика маркировки рекламы (если ERID есть — считается рекламой).
* `is_sponsored/sponsor_slot` — платные слоты.
* `is_turbo/turbo_mult` — режим усиленных показов (x2 и т.п.).
* `seed` — seed рандома (если применимо).
* `algo` — идентификатор алгоритма выдачи (`random_v1`, `rank_v2_fair`, `mix_v1`).
* `filters` — примененные фильтры (объект).
* `action` — только для кликов: `open|call|route|share|website|favorite|more`.
* `meta` — доп. данные (например: `screen`, `viewport`, `ab_variant`).

---

## 2) Правило “что считается показом” (Impression)

Показ считается только при выполнении всех условий:

1. Элемент реально отрендерен в DOM
2. Элемент видим в viewport по IntersectionObserver
3. Видимая доля **≥ 0.5 (50%)**
4. Видимость сохраняется **минимум 300 ms**
5. Показ засчитывается **один раз на одну выдачу** (request_id) на одну сущность (entity_id)

**Параметры фиксированы:**

* `threshold = 0.5`
* `minVisibleMs = 300`
* `dedupeScope = session + request_id + entity_id + event_type`

**Важно:**

* Скролл вверх-вниз НЕ должен добавлять повторные показы для той же выдачи.
* Подгрузка “load more” — это новая выдача или продолжение?

  * Если это добавление к текущей выдаче: request_id можно оставить тем же, но `pos` для новых элементов продолжается.
  * Если это отдельный запрос к API с другими параметрами — новый request_id.

---

## 3) Правило кликов (Click)

Клик считается при:

* клике по карточке целиком (открыть детали/попап/переход)
* клике по action-кнопкам внутри карточки

**action значения:**

* `open` — открыть карточку/попап/детали
* `call` — звонок
* `route` — маршрут
* `share` — поделиться
* `website` — перейти на сайт/внешнюю ссылку
* `favorite` — избранное
* `more` — “ещё/показать всё/загрузить ещё” (это клики уровня блока, entity_id может быть null)

**Дедуп кликов:**

* клики НЕ дедупятся жестко (иначе потеряем реальные повторные действия),
* но ставим защиту от “двоеклика”:

  * `antiDoubleClickMs = 350 ms` на одну и ту же кнопку/карточку.

---

## 4) Pos (позиционная аналитика)

`pos` фиксируется на момент первичного рендера карточек в блоке:

* первый элемент в массиве = pos 1
* далее по порядку

Если внутри блока есть “вклейки” (спонсорский слот, турбо, pinned):

* `pos` отражает фактический порядок на экране.
* `slot` заполняется для элементов, вставленных по слотам.

---

## 5) Request_id (обязательная дисциплина)

`request_id` обязателен всегда и везде.

Генерация:

* на каждом запросе к API/витрине создаем request_id (uuid)
* если отрисовали из кэша — request_id всё равно должен быть (можно тот же, что у кэшированной выдачи)

Смысл:

* request_id = “конкретная выдача/пачка карточек”
* без него невозможно честно считать показы и оценивать алгоритм

---

## 6) Dedupe (защита от дублей)

Дедуп ключ для impression:

`imp_key = session_id + "|" + request_id + "|" + entity_type + "|" + entity_id`

Храним в памяти + sessionStorage (TTL).

**TTL по умолчанию:**

* `impression_ttl_ms = 6 * 60 * 60 * 1000` (6 часов)

Почему:

* пользователь может вернуться на страницу, но мы не хотим “накрутку” при случайных перезагрузках.

---

## 7) Fairness (справедливость показов)

Цель: “недопоказанных допоказываем”, чтобы рандом не делал перекосов.

### 7.1 Основная идея

Выдача обязана учитывать “недопоказ” по аналитике и выравнивать распределение.

### 7.2 Модель (на уровне API/ранжирования)

На стороне выдачи (API) используем веса:

* `base_weight = 1`
* `freshness_weight` (свежесть/активность)
* `rating_weight` (если применимо)
* `fairness_boost` — коэффициент для недопоказанных

Пример:

* `fairness_boost = clamp(1, 3, target_impressions / max(1, actual_impressions))`

Где:

* `target_impressions` — целевой уровень показов (по сегменту: город/категория)
* `actual_impressions` — фактические показы за окно времени (например 7 дней)

### 7.3 Правило “не ломаем выдачу”

Fairness — не отменяет фильтры.
Сначала фильтры, потом fairness внутри фильтрованного пула.

---

## 8) Turbo (усиленные показы x2)

Turbo — платный режим усиления выдачи.
Он должен:

* давать больше показов
* не ломать маркировку рекламы
* не разрушать fairness полностью

### 8.1 Как трактуем Turbo

Turbo = увеличение вероятности попадания в выдачу/показ.
Не “фиксируем сверху всегда”, а усиливаем.

Поля:

* `is_turbo = true|false`
* `turbo_mult = 2` (или другое число)

### 8.2 Встраивание Turbo в ранжирование (API)

Рекомендуемая формула:

* `final_weight = base_weight * fairness_boost * turbo_mult * other_weights`

Границы:

* Turbo не должен давать 100% монополию. Вводим cap:

  * `turbo_cap_share = 0.35` (максимум 35% элементов выдачи могут быть turbo за одну выдачу)
  * спонсорские слоты (sponsor_slot) считаются отдельно и могут идти поверх.

### 8.3 Turbo + Fairness

Turbo усиливает, но fairness продолжает работать на остальных:

* если turbo элементов много — ограничиваем их долю
* оставшиеся места выдачи распределяем fairness-алгоритмом

---

## 9) Реклама и ERID (маркировка)

Если у сущности есть `erid` (не пустой):

* `is_ad = true`
* должен отображаться бейдж “Реклама” и попап с данными (UI-логика отдельно)
* в трекинг обязательно уходит `erid` и `ad_status`

Если `erid` отсутствует:

* `is_ad = false`
* маркировка не применяется

---

## 10) Где считается что (разделение ответственности)

### Клиент (Tilda/SDK)

* собирает события (impression/click)
* назначает session_id/anon_id
* присваивает pos на рендере
* отправляет события на endpoint

### Сервер (API/БД)

* хранит raw events
* строит rollup (по дням/часам)
* отдает в ранжирование fairness данные (actual_impressions)
* применяет turbo и fairness при выдаче

---

## 11) Минимальный набор обязательных параметров (не обсуждается)

Нельзя отправлять события без:

* ts
* session_id
* anon_id
* page_id
* page_type
* city_id
* block_id
* block_type
* request_id
* event
* entity_type
* entity_id (кроме событий блока типа `more`)
* pos (кроме событий блока типа `more`)

---

## 12) Acceptance Checklist (для каждого нового блока)

Перед тем как блок считается “готов”:

* [ ] Карточки отдают `entity_type/entity_id`
* [ ] На рендере выставляется `pos`
* [ ] Есть `block_id/block_type/page_id/page_type/city_id`
* [ ] Есть `request_id` на выдачу
* [ ] Impression считается по IntersectionObserver: 50% + 300ms
* [ ] Impression дедупится: session + request_id + entity_id
* [ ] Click пишет `action`
* [ ] Есть защита от double-click 350ms
* [ ] Если есть erid — `is_ad=true` и `erid` уходит в событие
* [ ] Turbo учитывается в выдаче и уходит в событие (`is_turbo/turbo_mult`)

Если хоть один пункт не выполнен — блок НЕ принимается.

---

КОНЕЦ TRACKING.md

```
```
